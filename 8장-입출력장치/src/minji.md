# 장치 컨트롤러와 장치 드라이버

## 장치 컨트롤러

- 입출력 장치는 종류가 다양하고 CPU와 메모리보다 데이터 전송률이 낮다는 특징 때문에 컴퓨터에 직접 연결되지 않고 장치 컨트롤러라는 하드웨어를 통해 연결됨
- 입출력 제어기, 입출력 모듈 등 다양하게 불림
- 장치 컨트롤러는 CPU와 입출력장치 간의 통신을 중개하고 오류를 검출하며 데이터 버퍼링을 통해 전송률 차이를 완화함
  - 데이터 버퍼링: 버퍼라는 임시 저장 공간에 데이터를 저장하여 전송률을 비슷하게 맞추는 방법
- 데이터 레지스터, 상태 레지스터, 제어 레지스터 등으로 구성되어 있음
  - 데이터 레지스터: CPU 와 입출력장치 사이에 주고 받을 데이터가 담기는 레지스터(버퍼 역할). 최근 주고 받는 데이터가 많은 입출력 장치의 경우 레지스터 대신 RAM 을 사용하기도 함
  - 상태 레지스터: 입출력장치의 상태 정보를 저장
  - 제어 레지스터: 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장

<br/><br/>

## 장치 드라이버

장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램

- 컴퓨터가 연결된 장치의 드라이버를 인식하고 실행할 수 있다면 컴퓨터 내부와 정보를 주고받을 수 있음
- 장치 드라이버를 인식하고 실행하는 주체는 운영체제임
- 장치 드라이버는 운영체제가 기본적으로 제공하는 것도 있지만 장치 제작자가 따로 제공하기도 함

<br/><br/><br/><br/>

# 다양한 입출력 방법

## 프로그램 입출력

프로그램 속 명령어로 입출력장치를 제어하는 방법

### 메모리 맵 입출력

메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법

- 컴퓨터에 1024개의 주소 공간이 있을 때 일부는 메모리 주소를 위해, 일부는 장치 컨트롤러의 레지스터를 표현하기 위해 사용
- 메모리 접근 명령어와 입출력장치 접근 명령어가 같음

### 고립형 입출력

메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법

- 제어 버스에 메모리에 대한 읽기/쓰기 선과 입출력 장치에 대한 읽기/쓰기 선을 분리함
- 컴퓨터에 1024개의 주소 공간이 있다면 메모리도 1024개의 공간을, 입출력장치도 1024개의 공간을 활용할 수 있음
- 메모리 접근 명령어와 다른 입출력장치 전용 명령어를 사용함

<br/><br/>

## 인터럽트 기반 입출력

장치 컨트롤러가 입출력 장치를 끝낸 뒤 CPU 에게 인터럽트 요청 신호를 보내면 CPU 가 잠시 하던일을 백업하고 인터럽트 서비스 루틴을 실행하는 방법

- 폴링(polling): 입출력 장치의 상태와 처리할 데이터를 주기적으로 확인하는 방식으로 인터럽트 방식보다 CPU의 부담이 큼
- 인터럽트가 동시에 여러 개 발생한 경우
  - 플래그 레지스터 속 인터럽트 비트가 활성화 된 경우: 순차적으로 하드웨어 인터럽트를 처리함
  - 인터럽트 비트가 활성화된 경우 or 무시할 수 없는 인터럽트(NMI, Non Maskable Interrupt)의 경우: 우선순위가높은 인터럽트부터 처리함

### 프로그래머블 인터럽트 컨트롤러(PIC, Programmable Interrupt Controller)

여러 개의 장치 컨트롤러와 연결되어 장치 컨트롤러에서 보낸 인터럽트 요청들의 우선순위를 판별한 뒤 지금 처리해야할 인터럽트가 무엇인지 알려주는 장치

- 여러 개의 핀으로 구성이 되어있고, 각 핀에는 약속된 하드웨어가 연결되어 있음
- 처리 과정<br/>
  1. PIC 가 장치 컨트롤러에서 인터럽트 요청 신호들을 받아들임
  2. 인터럽트 우선순위 판단 후 CPU 에 처리해야할 인터럽트 요청 신호를 보냄
  3. CPU가 PIC 에 인터럽트 확인 신호를 보냄
  4. 데이터 버스를 통해 CPU 에 인터럽트 벡터를 보냄
  5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게되고, 해당 장치의 인터럽트 서비스 루틴을 실행함
- 일반적으로 PIC 를 두 개 이상의 계층적으로 구성하여 더 많은 하드웨어 인터럽트를 관리할 수 있게 함
- NMI 까지 우선순위를 판별하진 않음(NMI 는 우선순위가 가장 높기 때문)

<br/><br/>

## DMA(Direct Memory Access) 입출력

입출력장치와 메모리가 CPU를 거치지 않고 상호작용할 수 있는 입출력 방식으로 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어를 사용함

- 시스템 버스는 공용 자원으로 동시 사용이 불가능함. 따라서 DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템버스를 이용하거나, CPU 가 일시적으로 사용하지 않도록 허락을 구하고 집중적으로 시스템버스를 이용함
- 사이클 스틸링: DMA의 시스템 버스 이용

### DMA 입출력 과정

1. CPU가 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령함
2. DMA 커느롤러가 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행. 이때 컨트롤러가 필요시 메모리에 각각 접근해 정보를 읽거나 씀
3. 입출력 작업 종료 시 DMA 컨트롤러가 CPU에 인터럽트를 걸어 작업이 끝났음을 알림

### 입출력 버스

DMA 컨트롤러와 장치 컨트롤러가 시스템 버스를 통해 연결된다면 CPU 가 시스템 버스를 이용하지 못하는 시간이 늘어나기 때문에 이를 방지하기 위해 DMA 컨트롤러와 장치 컨트롤러들은 입출력 버스라는 별도의 버스를 통해 연결함

- ex. PCI(Peripheral Component Interconnect)버스, PCI Express(PCIe) 버스 등
- 입출력 프로세서(IOP, Input/Output Pricessor) / 입출력 채널(Input/Output Channel): 입출력 전용 CPU
- 최근에는 메모리 접근, 입출력 명령어 인출/해석/실행을 위한 입출력 전용 CPU 가 포함되어 있는 경우가 많음
