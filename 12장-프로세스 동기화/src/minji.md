# 동기화란

## 동기화의 의미

- 프로세스들은 독립적이지만 공동의 목표를 위해 서로 협력해야하고 이를 위해 동기화가 필요함
- 프로세스 동기화: 프로세스 사이의 수행 시기를 맞추는 것
  - 실행 순서 제어: 프로세스를 올바른 순서대로 실행
  - 상호 배제: 동시에 접근해서 안되는 자원에 하나의 프로세스만 접근하게 함
- 실행의 흐름을 갖는 모든 것은 동기화의 대상이므로 스레드 또한 동기화의 대상임
- 생산자와 소비자 문제: 상호 배제 동기화와 관련된 고전 문제로 총합이라는 데이터를 공유하는 총합의 1을 증가시키는 생산자와 총합의 1을 감소시키는 소비자를 동시 실행하는 문제

<br/><br/>

## 공유 자원과 임계 구역

- 공유 자원: 프로세스들 간 공유되는 자원으로 전역 변수, 파일, 입출력 장치, 보조 기억 장치 등이 될 수 있음
- 임계 구역: 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
- 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기해야 함
- 레이스 컨디션: 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우
  - 데이터의 일관성이 깨지는 문제가 발생할 수 있음
  - 컴퓨터는 고급언어가 아닌 저급언어를 실행하기 때문에 저급언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 발생할 수 있고 이 때문에 레이스 컨디션이 발생할 수 있음
- 상호 배제를 위한 동기화 원칙
  1. 상호 배제(mutual exclusion): 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없음
  2. 진행(progress): 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 함
  3. 유한 대기(bounded waiting): 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 함(임계 구역에 들어오기 위해 무한정 대기해서는 안됨)

<br/><br/><br/><br/>

# 동기화 기법

## 뮤텍스 락

상호 배제를 위한 동기화 도구로 하나의 전역변수와 두 개의 함수로 구성

- `lock`: 프로세스들이 공유하는 전역 변수로 임계 구역의 잠금 여부를 확인할 수 있음
- `acquire`: 임계 구역 잠금
  - 프로세스가 임계 구역 진입 전에 호출
  - lock 이 false가 될 때까지 임계 구역을 반복적으로 확인하고 임계 구역이 열려 있다면 lock을 true 로 바꾸는 함수
- `release`: 임계 구역 잠금 해제
  - 프로세스가 임계 구역에서의 작업이 끝나고 호출
  - lock 을 false 로 바꿔주는 함수
- 바쁜 대기(busy wait): 쉴 새 없이 반복적으로 확인하며 대기하는 방식
- C/C++, python 등의 일부 언어에서는 acquire, release 함수를 구현하지 않도록 뮤텍스 락 기능을 제공하고 훨씬 정교하게 설계되어 있음

<br/><br/>

## 세마포(Semaphore)

뮤텍스 락과 비슷하지만 좀 더 일반화된 방식의 동기화 도구

- 이진 세마포, 카운팅 세마포가 있고, 카운팅 세마포는 여러 공유 자원에 대해 다룸
- 하나의 변수와 두 개의 함수로 구현
  - `S`: 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타내는 전역 변수
  - `wait`: 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 함수
    - 임계 구역 진입 전에 호출
    - S > 0 이 될 때까지 S를 반복적으로 확인하고 S를 1 감소 시킴
  - `signal`: 임계 구역 앞에서 기다리는 프로세스에 들어가도 좋다고 신호를 주는 함수
    - 임계 구역 진입 후에 호출
    - S를 1 증가 시킴
- wait, signal 함수는 P,V 나 down, up 으로 표현하기도 함
- 바쁜 대기를 반복하며 확인하면 CPU 주기를 낭비한다는 점에서 손해를 볼 수 있음 -> 실제 세마포는 다른 방법을 사용
- 실제 세마포 구현
  - `wait`
    - S를 감소시키고 S < 0 이면 프로세스의 PCB를 세마포를 위한 대기 큐에 삽입하고 대기 상태로 만듦
  - `signal`
    - S 를 증가시키고 S <= 0 이면 프로세서의 PCB 를 대기 큐에서 제거하고 프로세스 상태를 준비 상태로 만듦
- 세마포를 이용해 프로세스의 실행 순서를 제어하려면 S = 0 으로 두고 먼저 실행할 프로세스 뒤에 signal, 다음에 실행할 프로세스 앞에 wait 함수를 붙임
- 단점: wait, signal 함수를 일일이 명시하는 것이 번거롭고 실수를 낼 수 있음

<br/><br/>

## 모니터

### 상호배제

- 모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스를 묶어 관리하고 인터페이스를 통해서만 공유자원에 접할 수 있게 함
- 모니터에 진입하는 큐를 만들고 모니터 안에 항상 하나의 프로세스만 들어오도록 관리함

### 실행 순서 제어

- 조건 변수를 활용해 프로세스를 실행하거나 일시 중단함. -> 프로세스/스레드의 실행 순서를 위해 사용(조건변수 != 모니터. 그저 모니터가 조건 변수를 사용할 뿐임)
- 조건 변수로 wait과 signal 연산을 수행할 수 있음. 특정 프로세스가 아직 실행될 조건이 되지 않았을 때는 wait 을 통해 실행을 중단하고, 조건이 충족되면 signal 을 통해 실행을 재개함
  - wait: 프로세스 대기 상태로 전환 후 일시적으로 조건 변수에 대한 대기 큐에 삽입
  - signal: wait으로 인해 큐에 삽입된 프로세스의 실행을 재개하는 연산으로, wait으로 일시 중단된 프로세스는 다른 프로세스의 signal 을 통해 재개됨
- 모니터에 들어온 프로세스들은 프로세스의 실행 조건이 만족될 떄까지 잠시 실행이 중단되어 기다리게 됨
